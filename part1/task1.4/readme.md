Функции:
- [pthread_cancel](https://linux.die.net/man/3/pthread_cancel)
- [pthread_testcancel](https://linux.die.net/man/3/pthread_testcancel)
- [pthread_setcancelstate](https://linux.die.net/man/3/pthread_setcancelstate)

Замечания:
- `pthread_cancel()` посылает сигнал отмены потоку
- поведение потока зависит от двух атрибутов, которые находятся под контролем самого потока: состояние (`state`) и тип: (`type`)
- состояние отмены потока устанавливается с помощью  `pthread_setcancelstate(3)`
- по умолчанию поток не может быть отмененным
- если поток не может быть отмененным, то запрос на отмену будет в очереди, пока поток не изменит свое состояние
- если поток может быть отмененным, то процесс отмены будет определяться его типом
- тип устанавливается с помощью  `pthread_setcanceltype(3)`
- может быть асинхронным[^1] или отложенным[^2] (дефолтный)

При обработке запроса на отмену для потока выполняются следующие шаги (в указанном порядке):
1. Обработчики очистки отмены извлекаются (в обратном порядке, в котором они были помещены) и вызываются. (См. `pthread_cleanup_push(3)`)
2. Деструкторы данных, специфичные для потока, вызываются в неопределенном порядке. (См. `pthread_key_create(3)`)
3. Поток завершается. (См. `pthread_exit(3)`)

Вышеуказанные шаги происходят асинхронно по отношению к вызову `pthread_cancel()`; возвращаемый статус `pthread_cancel()` просто информирует вызывающую сторону, был ли запрос отмены успешно поставлен в очередь.

После завершения отмененного потока, присоединение к этому потоку с помощью `pthread_join(3)` получает `PTHREAD_CANCELED` в качестве статуса выхода потока. (Присоединение к потоку — единственный способ узнать, что отмена завершена.)

- В Linux отмена реализована с помощью сигналов. 
- При успехе pthread_cancel() возвращает ноль, при неудаче номер ошибки

---

- `void pthread_cleanup_push(void (*routine)(void *), void *arg);`
- `void pthread_cleanup_pop(int execute);`

Эти функции управляют стеком обработчиков очистки отмены потока вызывающего потока. Обработчик очистки — это функция, которая автоматически выполняется при отмене потока (или в различных других обстоятельствах, описанных ниже); например, она может разблокировать `мьютекс`, чтобы он стал доступен другим потокам
в процессе.

Функция `pthread_cleanup_push()` помещает процедуру на вершину
стека обработчиков очистки. Когда процедура вызывается позже, ей
будет дан `arg` в качестве аргумента.

Функция `pthread_cleanup_pop()` удаляет процедуру на вершине
стека обработчиков очистки и, при необходимости, выполняет ее, если
`execute` не равен нулю.

Обработчик очистки отмены извлекается из стека и выполняется в следующих случаях:
1. Когда поток отменяется, все стековые обработчики очистки извлекаются и выполняются в порядке, обратном порядку, в котором они были помещены в стек.
2. Когда поток завершается вызовом `pthread_exit(3)`, все обработчики очистки выполняются, как описано в предыдущем пункте. (Обработчики очистки не вызываются, если поток завершается выполнением возврата из функции запуска потока.)
3. Когда поток вызывает `pthread_cleanup_pop()` с ненулевым аргументом `execute`, самый верхний обработчик очистки извлекается и выполняется.

- Эта функция не возвращает значение
- В ней не происходят ошибки

[^1]: асинхронный тип означает, что поток может быть отменен в любое время, обычно это происходит сразу же, но система не гарантирует этого
[^2]: отложенный тип означает, что флаг отмены проверяется после вызова функций - точек отмены
